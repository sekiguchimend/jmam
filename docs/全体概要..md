# 職場改善スコア回答予測システム 要件定義書 (v2)

## 1. 概要

### 1.1. 背景と目的

個人の評価スコアに基づき、特定のケース問題に対する回答内容を予測・生成するWebサービスを開発する。これにより、スコアと回答の質の関係性を可視化し、能力開発や人材評価の示唆を得ることを目的とする。

本システムは、**管理者がアップロードした**約15万件の回答・評価データを活用し、指定されたスコアプロファイルに類似する過去の回答者を検索し、その回答を参考にLLM（大規模言語モデル）が新たな回答を生成するアプローチ（RAG: Retrieval-Augmented Generation）を採用する。

### 1.2. 対象利用者

- **一般利用者**: 予測機能を利用する人事担当者、研修企画者、管理職
- **システム管理者**: データのアップロードや管理を行う担当者

---

## 2. 機能要件

### 2.1. 一般利用者向け機能

| ID | 機能名 | 機能概要 |
|:---|:---|:---|
| FR-01 | ケース問題選択 | 複数のケース問題の中から、予測対象とする問題を選択できる。 |
| FR-02 | スコア入力 | 複数の評価項目（問題把握、対策立案など）について、1.0〜4.0の範囲で目標スコアをスライダー等で直感的に入力できる。 |
| FR-03 | 回答予測 | 入力されたスコアに基づき、システムのバックエンドが類似回答者を検索し、LLMが予測回答を生成する。 |
| FR-04 | 予測結果表示 | 生成された予測回答（問題把握、対策立案など）を画面に分かりやすく表示する。 |
| FR-05 | 回答比較 | スコアを変更した場合、変更前と変更後の予測回答を並べて表示し、その差分を容易に比較できる。 |

### 2.2. システム管理者向け機能

| ID | 機能名 | 機能概要 |
|:---|:---|:---|
| FR-06 | 管理画面認証 | システム管理者は、専用のID/パスワードで管理画面にログインする。 |
| FR-07 | CSVアップロード | 管理者は、回答データが含まれるCSVファイルをシステムにアップロードできる。 |
| FR-08 | データ検証 | アップロードされたCSVファイルに対し、システムは自動的にヘッダーの妥当性、データ型、必須項目の欠損チェックを行う。 |
| FR-09 | バッチ処理登録 | システムは、検証済みのデータを1000件単位のバッチでデータベースに登録（Upsert）する。これにより、大量データ処理時のタイムアウトを防ぐ。 |
| FR-10 | 進捗表示 | データ登録処理中、管理画面に進捗（例: 150000件中123000件処理完了）をリアルタイムで表示する。 |
| FR-11 | エラー報告 | データ検証や登録処理でエラーが発生した場合、どのファイルのどの行で問題が起きたかを具体的に画面に表示する。 |
| FR-12 | データセット管理 | アップロードしたデータセット（ファイル単位）の一覧を表示し、不要になったデータセットを物理削除できる機能を提供する。 |

---

## 3. 画面仕様（ワイヤーフレーム）

### 3.1. 一般利用者画面

（変更なし）

### 3.2. 管理者画面 (`/admin`)

```
┌─────────────────────────────────────────────────────────────┐
│  管理者画面                                                  │
├─────────────────────────────────────────────────────────────┤
│  [CSVファイルを選択]  [アップロード実行]                     │
│                                                             │
│  --- 処理状況 ---                                            │
│  ファイル名: J000000863005058一覧表.csv                      │
│  進捗: [■■■■■■■■■■■■■■■      ] 82% (123000 / 150000) │
│  エラー: 0件                                                 │
│                                                             │
│  --- アップロード済みデータセット ---                        │
│  [x] 2025-12-23 J000000863005058一覧表.csv (150000件)         │
│  [x] 2025-11-10 過去データ.csv (50000件)                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. データモデル（Supabase/PostgreSQL）

（変更なし）

---

## 5. システム構成

### 5.1. アーキテクチャ図

```mermaid
graph TD
    subgraph "ブラウザ"
        A[一般利用者] --> B[Next.js フロントエンド]
        F[管理者] --> G[Next.js 管理画面]
    end

    subgraph "Vercel"
        B -- APIリクエスト --> C[API Route (予測)]
        G -- アップロード --> H[API Route (データ処理)]
    end

    subgraph "外部サービス"
        D[Supabase] <--> C
        E[Google Gemini] <--> C
        D <--> H
    end

    style A fill:#cde4ff
    style F fill:#d2e2d8
```

### 5.2. データアップロード処理フロー

1.  **管理者ログイン**: 管理者が`/admin`ページにアクセスし、認証を通過する。
2.  **ファイルアップロード**: 管理者がCSVファイルをアップロードする。
3.  **バックエンド処理開始**: Next.jsのAPI Route (`/api/upload`) がファイルを受け取り、ストリーム処理を開始する。
4.  **データ検証**: 1行ずつデータを読み込み、ヘッダーやデータ型が正しいか検証する。
5.  **バッチ登録**: 1000行溜まるごとに、Supabaseの`upsert`機能を使ってデータベースに一括登録する。`upsert`により、IDが重複するデータは更新、新規データは挿入される。
6.  **進捗更新**: バッチ処理が1回完了するごとに、Server-Sent Events (SSE) などを通じてフロントエンドに進捗を通知する。
7.  **処理完了/エラー報告**: 全ての処理が完了したら、その旨を通知する。エラーが発生した場合は、エラー内容と該当箇所を通知し、処理を中断する。

---

# 非機能要件 (v2)

| 項目 | 要件内容 |
|:---|:---|
| **性能** | **予測応答時間**: ユーザーが「予測する」ボタンを押してから、結果が画面に表示されるまでの時間は**5秒以内**とする。<br>**データアップロード処理時間**: 15万件のCSVファイルのアップロード、検証、DB登録処理は**10分以内**に完了すること。（Vercelの実行時間制限を考慮し、必要であればVercel Cron Jobs等で非同期実行する） |
| **可用性** | **稼働率**: 99.5%以上を目指す。（VercelおよびSupabaseのSLAに準拠） |
| **セキュリティ** | **APIキー管理**: `GOOGLE_API_KEY` や `SUPABASE_SERVICE_ROLE_KEY` などの認証情報は、Vercelの環境変数に設定し、クライアントサイドには一切漏洩させない。<br>**データアクセス**: クライアントからデータベースへの直接アクセスは禁止し、必ずNext.jsのAPI Routeを経由させる。<br>**管理者認証**: 管理画面 (`/admin`) は、Next.js Auth等のライブラリを用いたID/パスワード認証で保護する。 |
| **保守性・運用性** | **データ更新**: 管理画面からCSVファイルをアップロードするだけで、システムが自動的に新しいデータを参照できるようにする。<br>**ロギング**: Vercelの標準機能を用いて、APIリクエストの成功・失敗ログを記録し、エラー発生時の原因調査を容易にする。<br>**エラーハンドリング**: データアップロード時にエラーが発生した場合、どのファイルのどの行で問題が起きたかを具体的にログに出力する。 |
| **技術スタック** | **フレームワーク**: Next.js (App Router)<br>**データベース**: Supabase (PostgreSQL)<br>**LLM**: Google Gemini (gemini-1.5-flashなど)<br>**UI**: React, Tailwind CSS<br>**デプロイ環境**: Vercel |
