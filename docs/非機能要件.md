# 職場改善スコア解答予測システム 開発仕様書

本ドキュメントは、「職場改善スコア解答予測システム」の開発に必要な技術仕様（データベーススキーマ、CSVアップロード仕様、非機能要件）を統合して定義するものです。

---

# 1. データベーススキーマ定義書

## 1.1. 設計思想

- **シンプルさ**: 予測機能に必要なデータを集約した単一のテーブル (`responses`) を中心に設計し、過度な正規化を避ける。
- **パフォーマンス**: 類似スコア検索を高速化するため、スコア関連のカラムに複合インデックスを設計する。
- **拡張性**: 将来的にケース問題やユーザー情報を別テーブルで管理できるよう、外部キー制約の追加を考慮した設計とする。

## 1.2. ER図

```mermaid
erDiagram
    responses {
        varchar(36) id PK "複合主キー (case_id + response_id)"
        varchar(20) case_id FK "題材コード"
        varchar(50) response_id "受注番号（個人ID）"
        date submitted_at "実施日"
        decimal(2,1) score_overall "演習総合評点"
        decimal(2,1) score_problem "問題把握評点"
        decimal(2,1) score_solution "対策立案評点"
        decimal(2,1) score_role "役割理解評点"
        decimal(2,1) score_leadership "主導評点"
        decimal(2,1) score_collaboration "連携評点"
        decimal(2,1) score_development "育成評点"
        text comment_overall "総合コメント"
        text comment_problem "問題把握コメント"
        text comment_solution "対策立案コメント"
        integer detail_problem_maintenance_biz "問題把握 維持管理 業務"
        integer detail_problem_maintenance_hr "問題把握 維持管理 人"
        integer detail_problem_reform_biz "問題把握 改革 業務"
        integer detail_problem_reform_hr "問題把握 改革 人"
        integer detail_problem_understanding "問題把握 状況理解"
        integer detail_problem_essence "問題把握 本質把握"
        text answer_q1 "設問1の解答"
        text answer_q2 "設問2の解答"
        text answer_q3 "設問3の解答"
        text answer_q4 "設問4の解答"
        text answer_q5 "設問5の解答"
        text answer_q6 "設問6の解答"
        text answer_q7 "設問7の解答"
        text answer_q8 "設問8の解答"
        text answer_q9 "設問9の解答"
        timestamp(6) created_at
        timestamp(6) updated_at
    }

    cases {
        varchar(20) case_id PK "題材コード"
        varchar(100) case_name "題材名"
        text situation_text "シチュエーション情報"
    }

    responses }|--|| cases : "references"
```

## 1.3. テーブル定義

### 1.3.1. `responses` テーブル

| 論理名 | 物理名 | 型 | PK | Null | デフォルト | 説明 |
|:---|:---|:---|:---:|:---:|:---|:---|
| ID | `id` | `VARCHAR(36)` | ✅ | | `gen_random_uuid()` | UUID形式のレコードID |
| 題材コード | `case_id` | `VARCHAR(20)` | | | | 外部キー (`cases.case_id`) |
| 解答者ID | `response_id` | `VARCHAR(50)` | | | | CSVの「受注番号」に相当 |
| 提出日 | `submitted_at` | `DATE` | | ✅ | | CSVの「実施日」 |
| **総合評点** | `score_overall` | `DECIMAL(2,1)` | | ✅ | | CSV: `Ⅱ　MC　演習総合評点` |
| **問題把握評点** | `score_problem` | `DECIMAL(2,1)` | | ✅ | | CSV: `Ⅱ　MC　問題把握評点` |
| **対策立案評点** | `score_solution` | `DECIMAL(2,1)` | | ✅ | | CSV: `Ⅱ　MC　対策立案評点` |
| **役割理解評点** | `score_role` | `DECIMAL(2,1)` | | ✅ | | CSV: `Ⅱ　MC　役割理解評点` |
| ... | `...` | `...` | | ✅ | | 他のスコア、コメント、詳細評価も同様に定義 |
| **設問1解答** | `answer_q1` | `TEXT` | | ✅ | | CSV: `【設問ID】　1` |
| ... | `...` | `...` | | ✅ | | 設問9まで同様に定義 |
| 作成日時 | `created_at` | `TIMESTAMP(6)` | | | `NOW()` | レコード作成日時 |
| 更新日時 | `updated_at` | `TIMESTAMP(6)` | | | `NOW()` | レコード更新日時 |

#### 制約

- **複合ユニーク制約**: `(case_id, response_id)`

### 1.3.2. `cases` テーブル

| 論理名 | 物理名 | 型 | PK | Null | 説明 |
|:---|:---|:---|:---:|:---:|:---|
| 題材コード | `case_id` | `VARCHAR(20)` | ✅ | | CSVの `Ⅱ　MC　題材コード` から抽出 |
| 題材名 | `case_name` | `VARCHAR(100)` | | | CSVの `Ⅱ　MC　題材名` から抽出 |
| シチュエーション | `situation_text` | `TEXT` | | ✅ | 別途提供の `題材別のシチュエーション情報.csv` から取得 |

## 1.4. インデックス設計

| インデックス名 | 対象テーブル | 対象カラム | 種類 | 目的 |
|:---|:---|:---|:---|:---|
| `idx_responses_on_scores` | `responses` | `(case_id, score_problem, score_solution, score_role)` | B-Tree | **最重要**: 類似スコア検索の高速化。 |
| `idx_responses_on_case_id_response_id` | `responses` | `(case_id, response_id)` | B-Tree (Unique) | Upsert処理の高速化とデータ一意性の担保。 |

---

# 2. CSVアップロード仕様書

## 2.1. アップロード処理フロー

```mermaid
sequenceDiagram
    participant Admin as 管理者
    participant Frontend as Next.js 管理画面
    participant Backend as Next.js API Route
    participant DB as Supabase (PostgreSQL)

    Admin->>Frontend: /admin にアクセスしログイン
    Admin->>Frontend: CSVファイルを選択し「アップロード」
    Frontend->>Backend: ファイルをPOSTリクエスト
    activate Backend

    Backend->>Backend: ストリーム処理開始
    Backend->>Backend: 1行目（ヘッダー）を読み込み検証
    alt ヘッダー不正
        Backend-->>Frontend: エラー応答 (400 Bad Request)
        deactivate Backend
    end

    loop 1行ずつ読み込み
        Backend->>Backend: データ変換・バリデーション
        alt データ不正
            Backend-->>Frontend: エラー応答（該当行、理由）
            deactivate Backend
        end
        Backend->>Backend: バッチに追加 (1000件ごと)
        
        opt バッチが1000件に達した
            Backend->>DB: UPSERT (1000件)
            DB-->>Backend: 処理結果
            Backend-->>Frontend: 進捗を通知 (SSE)
        end
    end

    opt 残りのバッチ処理
        Backend->>DB: UPSERT (残りの件数)
        DB-->>Backend: 処理結果
    end

    Backend-->>Frontend: 処理完了通知
    deactivate Backend
```

## 2.2. データマッピングと変換ルール

**注意**: CSVファイルの1行目はカラム名の日本語説明です。実装時は1行目をヘッダーとして読み込み、2行目以降をデータとして処理してください。

| CSVカラム名（1行目の値） | DBフィールド名 | 型 | 変換・バリデーションルール |
|:---|:---|:---|:---|
| `受注番号` | `response_id` | `VARCHAR(50)` | **必須**。前後の空白をトリム。 |
| `Ⅱ　MC　題材コード` | `case_id` | `VARCHAR(20)` | **必須**。前後の空白をトリム。 |
| `実施日` | `submitted_at` | `DATE` | `YYYY-MM-DD`形式に変換。変換できない場合はNULL。 |
| `Ⅱ　MC　演習総合評点` | `score_overall` | `DECIMAL(2,1)` | 数値に変換。変換できない、または範囲外(1.0-4.0)の場合はNULL。 |
| `【設問ID】　1` | `answer_q1` | `TEXT` | 文字列としてそのまま格納。 |
| ... | ... | ... | ... |

## 2.3. バリデーション（検証）仕様

| 検証項目 | エラー条件 | エラー処理 |
|:---|:---|:---|
| **ヘッダー行** | 1行目が存在しない、または必須カラム (`受注番号`, `Ⅱ　MC　題材コード`) が含まれていない。 | HTTP 400 (Bad Request) を返し、「ヘッダー行、または必須カラムが見つかりません」と通知。 |
| **必須項目** | `response_id` または `case_id` が空またはNULL。 | HTTP 400 (Bad Request) を返し、「XX行目: 必須項目が空です」と通知し、処理を中断。 |

## 2.4. データベース登録仕様

- **登録単位**: 1000レコードを1バッチとして処理する。
- **登録方法**: Supabase (PostgreSQL) の **`UPSERT`** 機能を使用する。
  - **競合キー**: `(case_id, response_id)`

---

# 3. 非機能要件定義書

| 大項目 | 中項目 | 要件ID | 要件内容 | 測定基準 |
|:---|:---|:---:|:---|:---|
| **性能** | **応答時間** | PE-01 | **予測機能**: ユーザーがスコアを入力し「予測」ボタンを押してから、結果が画面に表示されるまでの時間は**5秒以内**であること。 | ブラウザの開発者ツールまたは外部監視ツールで測定。95パーセンタイル値が5秒未満。 |
| | **処理時間** | PE-02 | **データアップロード**: 15万件のCSVファイルのアップロード、検証、DB登録処理は**10分以内**に完了すること。 | 管理画面での処理開始から完了通知までの時間を測定。 |
| **可用性** | **稼働率** | AV-01 | システム全体の月間稼働率は**99.5%**以上であること。 | VercelおよびSupabaseの公式ステータスページとSLAに基づき算出。 |
| **セキュリティ** | **認証** | SE-01 | **管理者認証**: 管理画面 (`/admin`) は、推測困難なID/パスワード認証によって保護されていること。 | Next.js Auth等の認証ライブラリのベストプラクティスに準拠。 |
| | **アクセス制御** | SE-03 | **DBアクセス**: クライアントサイド（ブラウザ）からSupabaseデータベースへの直接接続は禁止し、全てのDB操作はNext.jsのAPI Routeを経由すること。 | SupabaseのRLS（Row Level Security）ポリシーを設定し、`service_role`キーを持つサーバーサイドからのみ書き込みを許可。 |
| | **機密情報管理** | SE-04 | `GOOGLE_API_KEY`, `SUPABASE_SERVICE_ROLE_KEY`等のAPIキーやパスワードは、Vercelの環境変数に暗号化して保存し、ソースコードには一切ハードコーディングしないこと。 | Vercelの環境変数設定画面で確認。 |
| **保守性・運用性** | **ロギング** | MN-02 | **APIログ**: 全てのAPIリクエスト（成功/失敗）は、Vercelの標準ロギング機能によって記録されること。 | VercelのLogsタブで、リクエストパス、ステータスコード、実行時間が確認できる。 |
| | **デプロイ** | MN-06 | ソースコードのmainブランチにプッシュすると、自動的にテスト、ビルド、デプロイが実行されるCI/CDパイプラインが構築されていること。 | VercelのGit連携機能を利用。 |

## 3.1. 技術スタック

| レイヤー | 技術 | 理由 |
|:---|:---|:---|
| **フレームワーク** | Next.js (App Router) | フロントエンドとバックエンドをTypeScriptで統一でき、Vercelとの親和性が高い。 |
| **データベース** | Supabase (PostgreSQL) | フルマネージドのPostgreSQLであり、RLSによる強力なセキュリティ機能を持つ。 |
| **LLM** | Google Gemini (gemini-1.5-flash) | 高速かつコストパフォーマンスに優れた生成モデル。 |
| **UIライブラリ** | React, Tailwind CSS | モダンで効率的なUI開発が可能。 |
| **認証** | Next.js Auth | Next.jsに最適化された認証ライブラリ。 |
| **デプロイ環境** | Vercel | Next.jsに最適化されており、CI/CD、ロギング、環境変数管理が容易。 |
